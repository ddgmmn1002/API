<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body class="bg-dark">
    <div class="container align-content-center rounded bg-light p-5 mt-5 mb-5">
        <div class="row">
            <div class="col">
                <div class="rounded" id="map" style="width: 100%; height: 550px;"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5171b2a03363a2e54d7e61ca6fe42bc6"></script> //kakao map api
    <script>
        const mapContainer = document.getElementById('map'), // 지도 생성영역
            mapOption = {
                center: new kakao.maps.LatLng(35.179752695234136, 129.07470601185), // 지도 중심좌표
                level: 9 // 지도의 확대 레벨
            };

        const map = new kakao.maps.Map(mapContainer, mapOption); // 지도 객체 생성


        let url =
            "http://apis.data.go.kr/6260000/BusanTblRdemrfStusService/getTblRdemrfStusInfo";
        const authKey =
            "e81NBOj0iuvIAQazeEbvL6EfwDzRA2XK%2BZxtDFtTD8U4LRiKzZRxMdniDwIxt4EfhACShvsIXLTVkRGvMGwZew%3D%3D";
        let queryParams = "?" + encodeURIComponent("serviceKey") + "=" + authKey;
        queryParams +=
            "&" + encodeURIComponent("pageNo") + "=" + encodeURIComponent("1");
        queryParams +=
            "&" + encodeURIComponent("numOfRows") + "=" + encodeURIComponent("549");
        queryParams +=
            "&" + encodeURIComponent("resultType") + "=" + encodeURIComponent("json");
        //api url 생성
        console.log(url + queryParams);

        fetch(url + queryParams)
            .then((response) => { return response.json() })
            .then((data) => {
                const list = data.getTblRdemrfStusInfo.body.items.item;
                console.log(list);

                list.forEach((item) => {

                    //마커 이미지
                    const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
                    const imageSize = new kakao.maps.Size(12, 18);
                    const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                    //마커 생성하고 지도에 추가
                    const marker = new kakao.maps.Marker({
                        map: map, // 마커를 표시할 지도
                        position: new kakao.maps.LatLng(item.lat, item.lng),
                        image: markerImage,
                        clickable: true
                    });

                    //인포윈도우 내용
                    var iwContent =
                        '<div style="padding:10px;">' +
                        '<h5>' + item.reliefAg + '</h5>' +
                        '<br>' +
                        '<p> 주소: ' + item.roadAddr + '</p>' +
                        '<br>' +
                        '<p> 연락처: ' + item.tel + '</p>' +
                        '<br>' +
                        '<p> 수용가능인원: ' + item.accpNum + '</p>' +
                        '</div > ';

                    //인포윈도우 생성
                    var infowindow = new kakao.maps.InfoWindow({
                        content: iwContent
                    });


                    kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
                    kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));

                });
            })
            .catch((error) => console.log("error:", error));
        //api 요청

        // 인포윈도우를 표시하는 클로저를 만드는 함수입니다 
        function makeOverListener(map, marker, infowindow) {
            return function () {
                infowindow.open(map, marker);
            };
        }

        // 인포윈도우를 닫는 클로저를 만드는 함수입니다 
        function makeOutListener(infowindow) {
            return function () {
                infowindow.close();
            };
        }
    </script>
</body>

</html>